### Прикладное использование ProbStates

Этот документ описывает конкретные сценарии применения уровней 2–4 (вероятностные биты, p-биты и фазовые состояния) в задачах управления рисками, сенсорного слияния и A/B‑аналитики.

---

### Управление рисками

- Задача: объединение вероятностей независимых/слабо зависимых рисков, оценка неопределённости, ранжирование по информационной важности.
- Инструменты:
  - Уровень 2 (`ProbabilisticBit`): ⊕₂ для объединения «p(any)»; H₂(p) — мера неопределённости; D_KL — расстояние сценариев.
  - Уровень 3 (`PBit`): знак s кодирует «направление» фактора (усиливает/ослабляет риск); H₃ = H₂ + I_s фиксирует вклад полярности.
  - Уровень 4 (`PhaseState`): фаза φ отражает согласованность факторов; ⊕₄‑режимы позволяют выбрать политику агрегации: ‘quant’ (макс. интерференция), ‘norm’ (строгие границы), ‘weight’ (робастно), ‘opt’ (межуровневое соответствие), ‘custom’ (пользовательская).

Пример: объединение трёх факторов риска

```python
from probstates import ProbabilisticBit, PBit, PhaseState, set_phase_or_mode
from probstates.entropy import calculate_entropy, kl_divergence

# Базовый вариант (уровень 2)
r1, r2, r3 = ProbabilisticBit(0.12), ProbabilisticBit(0.08), ProbabilisticBit(0.18)
combined_p = r1 | r2 | r3
print("P(any) =", combined_p.probability, "H2 =", calculate_entropy(combined_p))

# Знак P-битов кодирует, усиливает (-1) или смягчает (+1) риск при насыщении
f1, f2, f3 = PBit(0.12, -1), PBit(0.08, +1), PBit(0.18, -1)
combined_pbit = (f1 | f2) | f3
print("H3 =", calculate_entropy(combined_pbit))

# Фазовая модель: φ≈0 — согласованные источники, φ≈π — конфликты/компенсация
set_phase_or_mode('weight')  # робастная агрегация
s1 = PhaseState(0.12, 0.0)
s2 = PhaseState(0.08, 0.1)
s3 = PhaseState(0.18, 3.1)   # почти противофаза → компенсация
agg = (s1 | s2) | s3
print("P≈", agg.probability, "H4 =", calculate_entropy(agg))

# Приоритизация факторов по информационной важности
print("KL(B_0.18 || B_0.12) =", kl_divergence(0.18, 0.12))
```

Рекомендации:
- Консервативная политика: ‘norm’ (чёткие границы), ‘weight’ (устойчиво к несогласованности).
- Исследовательская/верхняя оценка: ‘quant’ (максимальная интерференция).
- Когда важна согласованность L3↔L4: ‘opt’ с Δφ=π/2.

---

### Сенсорное слияние (sensor fusion)

- Задача: объединить показания нескольких сенсоров, учитывая согласованность, фазовый сдвиг и шум.
- Инструменты:
  - Уровень 4 (`PhaseState`): φ — относительная «фаза»/сдвиг между источниками; ⊕₄ для интерференции.
  - Шумовые каналы: `dephase(σφ)`, `amp_damp(α)`; мера когерентности `coherence_l1`.
  - `PhaseRegister`: гипотезы по сетке; FWHT как «грубый спектральный» шаг; POVM для решающих правил.

Пример: два сенсора с шумом и выбором режима ⊕₄

```python
import numpy as np
from probstates import PhaseState, set_phase_or_mode
from probstates.coherence import dephase, amp_damp

p1, p2 = 0.6, 0.55
phi1, phi2 = 0.0, np.deg2rad(30)
s1, s2 = PhaseState(p1, phi1), PhaseState(p2, phi2)

# Шум
s1 = dephase(amp_damp(s1, 0.2), sigma_phi=0.1)
s2 = dephase(amp_damp(s2, 0.2), sigma_phi=0.1)

# Робастное объединение
set_phase_or_mode('weight')
fused = s1 | s2
print(f"P_fused={fused.probability:.3f}")
```

Многогипотезный подход:

```python
from probstates import PhaseRegister

reg = PhaseRegister.uniform(3)           # 8 гипотез
reg.apply_oracle(lambda x: int(x in (1,3,4)))  # фазовый шаблон
reg.hadamard_all()
print("argmax hyp:", reg.argmax_probability())
```

Рекомендации:
- ‘weight’ для шумных источников с возможной несогласованностью.
- ‘norm’ когда строго требуется P∈[0,1] при накоплении многих источников.
- Анализ устойчивости: варьировать σφ, α и сравнивать H₄/коherency.

---

### A/B‑анализ

- Задача: сравнить варианты A и B по конверсии/успеху, измерить различие и неопределённость, планировать сбор данных.
- Инструменты:
  - Уровень 2: H₂(p) — неопределённость, D_KL(B_pA || B_pB) — асимметричная «сила» отличия.
  - Уровень 3/4: кодирование противоречивых сигналов (знак/фаза) при агрегации метрик из нескольких источников (каналы, сегменты, модели).

Пример: сравнение и минимальный план наблюдений

```python
from probstates.entropy import shannon_entropy, kl_divergence

pA, pB = 0.12, 0.145
print("H(A)=", shannon_entropy(pA), "H(B)=", shannon_entropy(pB))
print("KL(A||B)=", kl_divergence(pA, pB), "KL(B||A)=", kl_divergence(pB, pA))

# Эвристика числа наблюдений для детекта отличий по KL (инф. границы типа Чернова)
delta_kl = kl_divergence(pA, pB)
N_min ≈ 10.0 / max(delta_kl, 1e-6)
print("Примерная нижняя оценка N ~", round(N_min))
```

Агрегация показателей из нескольких каналов/сегментов:

```python
from probstates import PhaseState, set_phase_or_mode
set_phase_or_mode('norm')

# Каналы с потенциальной компенсацией ошибок/смещения
ch = [PhaseState(0.13, 0.0), PhaseState(0.11, 3.1), PhaseState(0.12, 0.2)]
res = ch[0]
for c in ch[1:]:
    res = res | c
print("Aggregated p:", res.probability)
```

Рекомендации:
- Использовать H₂ и KL для принятия решений о значимости и объёме трафика.
- При интеграции гетерогенных метрик — кодировать противоречия на L3/L4 (знак/фаза) и выбирать режим ⊕₄ под бизнес‑риск (консервативно: ‘norm’/‘weight’, агрессивно: ‘quant’).

---

### Выбор режима ⊕₄ (кратко)

- ‘quant’: максимальная интерференция (исследования/верхняя оценка).
- ‘norm’: строгая вероятностная граница при сложении многих источников.
- ‘weight’: компромисс, робастно к несогласованности.
- ‘opt’ (Δφ=π/2): соответствие 3↔4 для дизъюнкции.
- ‘custom’: задайте свою политику `set_phase_or_custom` под конкретную предметную область.


